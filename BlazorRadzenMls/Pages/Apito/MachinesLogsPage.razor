@attribute [Route(AppValues.PageMachinesLogs)]

@attribute [Authorize]
@* @attribute [Authorize(Roles = "administrator, manager")] *@
@* @attribute [Authorize(Policy = "admin-policy")] *@

@using BlazorRadzenMls.Models

@inject IApito _apito

<RadzenText Text="@__lang["Machines Logs"]" TextStyle="TextStyle.H4" class="rz-color-primary" />

@if (dataLogs != null)
{
    <RadzenDataGrid @ref="grid" Data="@dataLogs" TItem="MachinesLogs" @bind-Value="selectedLogs"
                    PageSize="10" AllowPaging="true" AllowSorting="true" IsLoading="@busyDelete"
                    PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                    AllowFiltering="true" FilterMode="FilterMode.Advanced"
                    SelectionMode="DataGridSelectionMode.Multiple">
        <HeaderTemplate>
            <RadzenButton Text="Reload" Icon="autorenew" Click="() => Clear(true)" IsBusy="@busyDelete"
                          ButtonStyle="ButtonStyle.Info" />
            <RadzenButton Text="Delete" Icon="delete_forever" Click="@DeleteLogs" IsBusy="@busyDelete"
                          ButtonStyle="ButtonStyle.Danger" Disabled="@disabledDelete" />
            <RadzenSplitButton Text="@clearBtnText" Disabled="@disabledDelete" Click="() => Clear()" IsBusy="@busyDelete"
                               Icon="cached" ButtonStyle="ButtonStyle.Info">
                <ChildContent>
                    @if (selectedLogs != null)
                    {
                        <div style="width: 266px; max-height: 366px; overflow: auto; padding: 10px;">
                            @foreach (var itm in selectedLogs)
                            {
                                <RadzenText TextStyle="TextStyle.Body2"
                                            Style="display: flex; white-space: nowrap; text-overflow: ellipsis;">
                                    @SelectLabel(@itm.Value!)
                                    <RadzenIcon Icon="done" IconColor="var(--rz-dropdown-open-background-color)" />
                                </RadzenText>
                            }
                        </div>
                    }
                </ChildContent>
            </RadzenSplitButton>
            @time
        </HeaderTemplate>
        
        <Template Context="logs">
            <RadzenCard Style="margin-bottom:20px">
                Company: <b>@logs.Hash</b>
            </RadzenCard>
        </Template>
        
        <Columns>
            <RadzenDataGridColumn Width="40px" Sortable="false" Filterable="false">
                <HeaderTemplate>
                    <RadzenCheckBox TriState="false" TValue="bool?"
                                    Value="@(selectedLogs == null || selectedLogs?.Any() != true ? false : !dataLogs.All(i => selectedLogs.Select(e => e.Id).Contains(i.Id)) ? null : dataLogs.Any(i => selectedLogs.Select(e => e.Id).Contains(i.Id)))"
                                    Change="@(args => selectedLogs = args == true ? (selectedLogs ?? Enumerable.Empty<MachinesLogs>()).Union(dataLogs.Where(i => !(selectedLogs ?? Enumerable.Empty<MachinesLogs>()).Select(e => e.Id).Contains(i.Id))).ToList() : null)" />
                </HeaderTemplate>
                <Template Context="data">
                    <RadzenCheckBox TriState="false" TValue="bool"
                                    Value="@(selectedLogs != null && selectedLogs.Select(e => e.Id).Contains(data.Id))" />
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn Property="Value" Title="Executed" />
            <RadzenDataGridColumn Property="Api" Title="Api" Width="100px" />
            <RadzenDataGridColumn Property="Desktop" Title="Desktop" Width="100px" />
            <RadzenDataGridColumn Property="DateOnly" Title="Date" FormatString="{0:d}" Width="100px" />
        </Columns>
    </RadzenDataGrid>
}
else
{
    @if (waitingRequest)
    {
        <div class="loader">Loading...</div>
    }
    else
    {
        @ResponseText
    }
}

@code {

    private bool disabledDelete => (selectedLogs == null || selectedLogs!.Count == 0) ? true : false;
    private bool busyDelete;
    private string clearBtnText => disabledDelete ? "Clear selected" : "Clear selected" + " [" + selectedLogs!.Count + "]";
    private int i;

    private RadzenDataGrid<MachinesLogs>? grid;
    private MachinesLogs[]? dataLogs;
    private IList<MachinesLogs>? selectedLogs;

    private Density density = Density.Default;

    private string? time;
    private string? ResponseText;
    private bool waitingRequest;

    private async Task DeleteLogs()
    {
        if (selectedLogs == null)
            return;
        busyDelete = true;
        await DeleteLogsFromApi();
        DeleteLogsFromGrid();
        busyDelete = false;
    }
    private async Task DeleteLogsFromApi()
    {
        var ids = selectedLogs!.Select(p => p.Id).ToArray();
        var response = await _apito.DeleteMachinesLogs(ids!);

        long total = response.RequestTime + response.DeserializeTime;
        time = $"[{response.RequestTime}ms {response.DeserializeTime}ms] {AppValues.FormatMilliseconds(total)}";
    }
    private void DeleteLogsFromGrid()
    {
        var oldData = dataLogs!.ToList();
        foreach (var item in selectedLogs!)
        {
            var log = oldData.Where(p => p.Id == item.Id).FirstOrDefault();
            if (log == null)
                break;
            oldData.Remove(log);
        }
        dataLogs = oldData.ToArray();
        selectedLogs = null;
    }

    private async Task Clear(bool reload = false)
    {
        waitingRequest = true;
        selectedLogs = null;
        if (reload)
        {
            dataLogs = null;
            await GetMachinesLogs();
            // grid.Reset(true);
            // await grid.FirstPage(true);
        }
        waitingRequest = false;
    }

    private string? SelectLabel(string text)
    {
        int number = i + 1;
        string result = $"[{number}] {text}";
        if (selectedLogs!.Count - 1 == i)
            i = 0;
        else
            i++;
        return result;
    }

    private async Task GetMachinesLogs()
    {
        waitingRequest = true;
        Response response = await _apito.GetMachinesLogs();
        dataLogs = (MachinesLogs[]?)response.Result;

        long total = response.RequestTime + response.DeserializeTime;
        time = $"[{response.RequestTime}ms {response.DeserializeTime}ms] {AppValues.FormatMilliseconds(total)}";
        waitingRequest = false;
    }

    protected override async Task OnInitializedAsync()
    {
        await GetMachinesLogs();
        // bool res = false;
        // try { res = await __js.InvokeAsync<bool>("isMobileDevice"); }
        // catch { Console.WriteLine("js error: MachinesLogsPage.razor -> OnInitializedAsync"); }
    }

}